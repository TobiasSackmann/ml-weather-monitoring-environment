---
- hosts: k3s_cluster
  tasks:
  - name: install apt pre-requisites
    become: yes
    apt:
      name:
        - python3-pip
        - snap
      update_cache: yes
  - name: install pip pre-requisites
    pip:
      name:
        - openshift
        - pyyaml
        - kubernetes
  - name: install helm
    become: yes
    snap:
      name:
        - helm
      classic: true
  - name: install Helm Diff Plugin
    kubernetes.core.helm_plugin:
      plugin_path: https://github.com/databus23/helm-diff
      state: present
  - name: copy kubeconfig to home directory
    become: yes
    ansible.builtin.copy:
      src: /etc/rancher/k3s/k3s.yaml
      dest: /home/{{ ansible_user }}/.kube/config 
      remote_src: true
      owner: '{{ ansible_user }}'
      mode: '0700'
  - name: Create monitoring namespace
    kubernetes.core.k8s:
      name: monitoring
      api_version: v1
      kind: Namespace
      state: present
  - name: Add stable grafana chart repo
    kubernetes.core.helm_repository:
      name: grafana
      repo_url: "https://grafana.github.io/helm-charts"
  - name: Add stable influxdb chart repo
    kubernetes.core.helm_repository:
      name: influxdata
      repo_url: "https://helm.influxdata.com/"
  - name: Update Helm Repos
    command: helm repo update
  - name: Deploy latest version of Grafana chart inside monitoring namespace with values
    kubernetes.core.helm:
      name: grafana
      chart_ref: grafana/grafana
      release_namespace: monitoring
      values:
        replicas: 1
        ingress:
          enabled: true
          hosts:
            - tig.grafana.local
          path: /
  - name: Deploy and configure latest version of Influxdb2 chart
    kubernetes.core.helm:
      name: influxdb
      chart_ref: influxdata/influxdb2
      release_namespace: monitoring
      values:
        ingress:
          enabled: true
          hostname: tig.influxdb.local
          className: traefik
          path: /
        service:
          type: NodePort #ClusterIP 
          nodePort: 30000
        adminUser:
          organization: "influxdata"
          bucket: "default"
          user: "admin"
          password: "password"
          token: "securetoken"
  - name: Deploy and configure latest version of Telegraf chart
    kubernetes.core.helm:
      name: telegraf
      chart_ref: influxdata/telegraf
      release_namespace: monitoring
      values:
        service:
          enabled: false
        config:
          inputs:
            - http:
                urls:
                  - "https://dwd.api.proxy.bund.dev/v30/stationOverviewExtended?stationIds=10838,10840"
                method: "GET"
                interval: "10s"
                response_timeout: "10s"
                data_format: "json"
          outputs:
            - influxdb_v2:
                urls:
                  - " "
                organization: "influxdata"
                bucket: "default"
                token: "securetoken"

